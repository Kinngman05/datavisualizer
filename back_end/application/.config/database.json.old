{
    "databases": {
        "stocks": {
            "tables": {
                "users": {
                    "table_constrains": {
                        "uid": "CHAR(10) NOT NULL",
                        "name": "VARCHAR(100) NOT NULL",
                        "email": "VARCHAR(50) NOT NULL",
                        "password": "VARCHAR(100) NOT NULL"
                    },
                    "read_list": null,
                    "index_constrains": null,
                    "primary_key": "uid",
                    "foreign_key": null,
                    "initial_data": null
                },
                "stocks": {
                    "table_constrains": {
                        "uid": "CHAR(10) NOT NULL",
                        "stock_name": "VARCHAR(50) NOT NULL",
                        "symbol": "VARCHAR(10) NOT NULL",
                        "from_date": "DATE NOT NULL",
                        "to_date": "DATE NOT NULL"
                    },
                    "read_list": null,
                    "index_constrains": null,
                    "primary_key": "uid",
                    "foreign_key": [
                        {
                            "constraint_name": null,
                            "foreign_table_name": "users",
                            "child_attribute": [
                                "uid"
                            ],
                            "parent_attribute": [
                                "uid"
                            ]
                        }
                    ],
                    "initial_data": null
                },
                "raw_data_bhel": {
                    "table_constrains": {
                        "date": "DATE NOT NULL",
                        "prev_close": "DECIMAL(12,2) NOT NULL",
                        "open": "DECIMAL(12,2) NOT NULL",
                        "high": "DECIMAL(12,2) NOT NULL",
                        "low": "DECIMAL(12,2) NOT NULL",
                        "last_price": "DECIMAL(12,2) NOT NULL",
                        "close": "DECIMAL(12,2) NOT NULL",
                        "VWAP": "DECIMAL(12,2) NOT NULL",
                        "total_traded_qty": "INT NOT NULL",
                        "turnover": "DECIMAL(12,2) DEFAULT NULL",
                        "no_of_trades": "INT DEFAULT NULL",
                        "deliverable_quantity": "INT DEFAULT NULL",
                        "percent_calc": "DECIMAL(6,2) DEFAULT NULL"
                    },
                    "read_list": null,
                    "index_constrains": null,
                    "primary_key": "date",
                    "foreign_key": null,
                    "initial_data": [
                        {
                            "date": "2019-04-01",
                            "prev_close": 74.95,
                            "open": 75.45,
                            "high": 77.85,
                            "low": 74.8,
                            "last_price": 75.95,
                            "close": 75.95,
                            "VWAP": 76.64,
                            "total_traded_qty": 25156745,
                            "turnover": 1927944473.5,
                            "no_of_trades": 45079,
                            "deliverable_quantity": 9163086,
                            "percent_calc": 36.42
                        }
                    ]
                },
                "sigma_bhel": {
                    "table_constrains": {
                        "date": "date NOT NULL",
                        "ln_returns": "DECIMAL (7,4)",
                        "prev_volatility": "DECIMAL(7,4)",
                        "daily_volatility": "DECIMAL(7,4)",
                        "sigma_0_5": "DECIMAL(7,4)",
                        "sigma_1_0": "DECIMAL(7,4)",
                        "sigma_1_5": "DECIMAL(7,4)",
                        "sigma_2_0": "DECIMAL(7,4)",
                        "p_sigma_0_5": "DECIMAL(7,4)",
                        "p_sigma_1_0": "DECIMAL(7,4)",
                        "p_sigma_1_5": "DECIMAL(7,4)",
                        "p_sigma_2_0": "DECIMAL(7,4)",
                        "n_sigma_0_5": "DECIMAL(7,4)",
                        "n_sigma_1_0": "DECIMAL(7,4)",
                        "n_sigma_1_5": "DECIMAL(7,4)",
                        "n_sigma_2_0": "DECIMAL(7,4)"
                    },
                    "read_list": null,
                    "index_constrains": null,
                    "primary_key": "date",
                    "foreign_key": [
                        {
                            "constraint_name": null,
                            "foreign_table_name": "raw_data_bhel",
                            "child_attribute": [
                                "date"
                            ],
                            "parent_attribute": [
                                "date"
                            ]
                        }
                    ],
                    "initial_data": [
                        {
                            "date": "2019-04-01",
                            "ln_returns": 0.0133,
                            "prev_volatility": 0.0216,
                            "daily_volatility": 0.0212,
                            "sigma_0_5": 0.8124,
                            "sigma_1_0": 1.6248,
                            "sigma_1_5": 2.4372,
                            "sigma_2_0": 3.2495,
                            "p_sigma_0_5": 77.4524,
                            "p_sigma_1_0": 78.2648,
                            "p_sigma_1_5": 79.0772,
                            "p_sigma_2_0": 79.8895,
                            "n_sigma_0_5": 75.8276,
                            "n_sigma_1_0": 75.0152,
                            "n_sigma_1_5": 74.2028,
                            "n_sigma_2_0": 73.3905
                        }
                    ]
                },
                "logs": {
                    "table_constrains": {
                        "date": "DATETIME DEFAULT NOW() NOT NULl",
                        "string": "VARCHAR(500)"
                    },
                    "read_list": null,
                    "index_constrains": null,
                    "primary_key": null,
                    "foreign_key": null,
                    "initial_data": null
                },
                "rsi_bhel": {
                    "table_constrains": {
                        "date": "DATE NOT NULl",
                        "cur_prev_close_diff": "DECIMAL(12,4) NOT NULL",
                        "avg_gain": "DECIMAL(12,4) DEFAULT NULL",
                        "avg_loss": "DECIMAL(12,4) DEFAULT NULL",
                        "rs": "DECIMAL(12,4) DEFAULT NULL",
                        "rsi": "DECIMAL(12,4) DEFAULT NULL"
                    },
                    "read_list": null,
                    "index_constrains": null,
                    "primary_key": "date",
                    "foreign_key": [
                        {
                            "constraint_name": null,
                            "foreign_table_name": "raw_data_bhel",
                            "child_attribute": [
                                "date"
                            ],
                            "parent_attribute": [
                                "date"
                            ]
                        }
                    ],
                    "initial_data": [
                        {
                            "date": "2019-04-01",
                            "cur_prev_close_diff": "-1.00"
                        }
                    ]
                },
                "vwap_bhel": {
                    "table_constrains": {
                        "date": "DATE NOT NULL",
                        "vwap_3": "DECIMAL(12,4) DEFAULT NULL",
                        "vwap_5": "DECIMAL(12,4) DEFAULT NULL",
                        "vwap_7": "DECIMAL(12,4) DEFAULT NULL",
                        "vwap_11": "DECIMAL(12,4) DEFAULT NULL",
                        "vwap_13": "DECIMAL(12,4) DEFAULT NULL",
                        "vwap_17": "DECIMAL(12,4) DEFAULT NULL",
                        "vwap_21": "DECIMAL(12,4) DEFAULT NULL"
                    },
                    "read_list": null,
                    "index_constrains": null,
                    "primary_key": "date",
                    "foreign_key": [
                        {
                            "constraint_name": null,
                            "foreign_table_name": "raw_data_bhel",
                            "child_attribute": [
                                "date"
                            ],
                            "parent_attribute": [
                                "date"
                            ]
                        }
                    ],
                    "initial_data": [
                        {
                            "date": "2019-04-01",
                            "vwap_3": "null",
                            "vwap_5": "null",
                            "vwap_7": "null",
                            "vwap_11": "null",
                            "vwap_13": "null",
                            "vwap_17": "null",
                            "vwap_21": "null"
                        }
                    ]
                }
            }
        }
    },
    "procedures": [
        {
            "procedure_name": "get_prev_row_data",
            "procedure_parameters": [
                "IN _attribute_name VARCHAR(100)",
                "IN _table_name VARCHAR(100)",
                "IN _date DATE",
                "IN _no_of_tuples INT",
                "OUT _average DECIMAL(12,4)"
            ],
            "procedures": [
                "SET @query_string=CONCAT(\"SET @average_5=(SELECT AVG(VWAP) FROM(SELECT `date`,`\",_attribute_name);",
                "SET @query_string=CONCAT(@query_string,\"` FROM `\");",
                "SET @query_string=CONCAT(@query_string,_table_name);",
                "SET @query_string=CONCAT(@query_string,\"` WHERE `date`<='\");",
                "SET @query_string=CONCAT(@query_string,_date);",
                "SET @query_string=CONCAT(@query_string,\"' ORDER BY `date` DESC LIMIT \");",
                "SET @query_string=CONCAT(@query_string,_no_of_tuples);",
                "SET @query_string=CONCAT(@query_string,\")a)\");",
                "PREPARE query FROM @query_string;",
                "EXECUTE query;",
                "DEALLOCATE PREPARE query;",
                "INSERT INTO logs(string) VALUES(CONCAT(@query_string,\":\",@average_5));"
            ]
        },
        {
            "procedure_name": "vwap_sigma_calc",
            "procedure_parameters": [
                "IN _date DATE",
                "IN _close DECIMAL(12,2)",
                "IN _prev_close DECIMAL(12,2)"
            ],
            "procedures": [
                "SET @prev_vol=(SELECT daily_volatility FROM `sigma_bhel` where `sigma_bhel`.`date`<_date ORDER BY `sigma_bhel`.`date` DESC LIMIT 1);",
                "SET @ln_returns=(ROUND(LOG(_close/_prev_close),4));",
                "SET @daily_vol=(SQRT((.94*@prev_vol*@prev_vol)+(.06*@ln_returns*@ln_returns)));",
                "SET @vwap=(SELECT vwap FROM raw_data_bhel WHERE `date`=_date);",
                "INSERT INTO logs(string) VALUES(CONCAT(\"The vwap for date \",_date,\" is:\",@vwap));",
                "SET @sigma_0_5=(@vwap*@daily_vol*.5);",
                "SET @sigma_1_0=(@vwap*@daily_vol*1);",
                "SET @sigma_1_5=(@vwap*@daily_vol*1.5);",
                "SET @sigma_2_0=(@vwap*@daily_vol*2);",
                "SET @p_sigma_0_5=(@vwap+@sigma_0_5);",
                "SET @p_sigma_1_0=(@vwap+@sigma_1_0);",
                "SET @p_sigma_1_5=(@vwap+@sigma_1_5);",
                "SET @p_sigma_2_0=(@vwap+@sigma_2_0);",
                "SET @n_sigma_0_5=(@vwap-@sigma_0_5);",
                "SET @n_sigma_1_0=(@vwap-@sigma_1_0);",
                "SET @n_sigma_1_5=(@vwap-@sigma_1_5);",
                "SET @n_sigma_2_0=(@vwap-@sigma_2_0);",
                "INSERT INTO logs(string) VALUES(CONCAT(\"The p_n for date \",_date,\" is:\",@p_sigma_0_5,@p_sigma_1_0,@p_sigma_1_5,@p_sigma_2_0,@n_sigma_0_5,@n_sigma_1_0,@n_sigma_1_5,@n_sigma_2_0));",
                "INSERT INTO `sigma_bhel`(`date`,`ln_returns`,`prev_volatility`,`daily_volatility`,`sigma_0_5`,`sigma_1_0`,`sigma_1_5`,`sigma_2_0`,`p_sigma_0_5`,`p_sigma_1_0`,`p_sigma_1_5`,`p_sigma_2_0`,`n_sigma_0_5`,`n_sigma_1_0`,`n_sigma_1_5`,`n_sigma_2_0`) VALUES(_date,@ln_returns,@prev_vol,@daily_vol,@sigma_0_5,@sigma_1_0,@sigma_1_5,@sigma_2_0,@p_sigma_0_5,@p_sigma_1_0,@p_sigma_1_5,@p_sigma_2_0,@n_sigma_0_5,@n_sigma_1_0,@n_sigma_1_5,@n_sigma_2_0);"
            ]
        },
        {
            "procedure_name": "rsi_calc",
            "procedure_parameters": [
                "IN _date DATE",
                "IN _close DECIMAL(12,2)",
                "IN _prev_close DECIMAL(12,2)",
                "IN _days INT"
            ],
            "procedures": [
                "INSERT INTO logs(string) VALUES(CONCAT(\"Input data is\",_date,\":\",_close,\":\",_prev_close,\":\",_days));",
                "SET @diff=_prev_close-_close;",
                "INSERT INTO logs(string) VALUES(CONCAT(\"rsi_index\",@diff));",
                "SET @no_of_records=(SELECT COUNT(*) FROM (select date,cur_prev_close_diff from rsi_bhel where date<_date ORDER BY date DESC LIMIT _days)a);",
                "SET @avg_gain=(SELECT IF (@no_of_records=_days,SUM(cur_prev_close_diff),0) FROM (select date,cur_prev_close_diff from rsi_bhel where date<_date ORDER BY date DESC LIMIT _days)a where cur_prev_close_diff>0);",
                "SET @avg_loss=(SELECT IF (@no_of_records=_days,(-1*(SUM(cur_prev_close_diff))),0) FROM (select date,cur_prev_close_diff from rsi_bhel where date<_date ORDER BY date DESC LIMIT _days)a where cur_prev_close_diff<0);",
                "INSERT INTO logs(string) VALUES(CONCAT(\"rsi_index_gain\",@diff,\":\",@avg_gain));",
                "INSERT INTO logs(string) VALUES(CONCAT(\"rsi_index_loss\",@diff,\":\",@avg_loss));",
                "SET @rs=(@avg_gain/@avg_loss);",
                "SET @rsi=(100-(100/(1+@rs)));",
                "INSERT INTO rsi_bhel(`date`,`cur_prev_close_diff`,`avg_gain`,`avg_loss`,`rs`,`rsi`) VALUES(_date,@diff,@avg_gain,@avg_loss,@rs,@rsi);"
            ]
        },
        {
            "procedure_name": "vwap_calc",
            "procedure_parameters": [
                "IN _date DATE",
                "IN _days INT",
                "OUT _vwap DECIMAL(21,4)"
            ],
            "procedures": [
                "SET @vwap=(SELECT IF(COUNT(VWAP)=_days,AVG(VWAP),NULL) FROM (SELECT VWAP FROM raw_data_bhel WHERE date<=_date ORDER BY date DESC LIMIT _days)a);",
                "SET _vwap=@vwap;",
                "INSERT INTO logs(string) VALUES(CONCAT(\"The calculated vwap is:\",@vwap));"
            ]
        }
    ],
    "triggers": [
        {
            "trigger_name": "test_AFTER_INSERT",
            "trigger_time": "AFTER INSERT",
            "database_name": "stocks",
            "table_name": "raw_data_bhel",
            "queries": [
                "CALL vwap_sigma_calc(NEW.`date`,NEW.`close`,NEW.`prev_close`);",
                "CALL rsi_calc(NEW.`date`,NEW.`close`,NEW.`prev_close`,14);",
                "SET @vwap_3=0,@vwap_5=0,@vwap_7=0,@vwap_11=0,@vwap_13=0,@vwap_17=0,@vwap_21=0;",
                "CALL vwap_calc(NEW.`date`,3,@vwap_3);",
                "CALL vwap_calc(NEW.`date`,5,@vwap_5);",
                "CALL vwap_calc(NEW.`date`,7,@vwap_7);",
                "CALL vwap_calc(NEW.`date`,11,@vwap_11);",
                "CALL vwap_calc(NEW.`date`,13,@vwap_13);",
                "CALL vwap_calc(NEW.`date`,17,@vwap_17);",
                "CALL vwap_calc(NEW.`date`,21,@vwap_21);",
                "INSERT INTO vwap_bhel(date,vwap_3,vwap_5,vwap_7,vwap_11,vwap_13,vwap_17,vwap_21) VALUES(NEW.`date`,@vwap_3,@vwap_5,@vwap_7,@vwap_11,@vwap_13,@vwap_17,@vwap_21);"
            ]
        }
    ],
    "initial_data": null,
    "views": [
        {
            "name": "final_bhel",
            "query": "SELECT sigma_bhel.date,prev_close,open,high,low,close,VWAP,ln_returns,prev_volatility,daily_volatility,`sigma_0_5`,`sigma_1_0`,`sigma_1_5`,`sigma_2_0`,`p_sigma_0_5`,`p_sigma_1_0`,`p_sigma_1_5`,`p_sigma_2_0`,`n_sigma_0_5`,`n_sigma_1_0`,`n_sigma_1_5`,`n_sigma_2_0`,avg_gain,avg_loss,rs,rsi,vwap_3,vwap_5,vwap_7,vwap_11,vwap_13,vwap_17,vwap_21 FROM sigma_bhel,raw_data_bhel,rsi_bhel,vwap_bhel WHERE sigma_bhel.date=raw_data_bhel.date AND sigma_bhel.date=rsi_bhel.date AND sigma_bhel.date=vwap_bhel.date;"
        }
    ]
}